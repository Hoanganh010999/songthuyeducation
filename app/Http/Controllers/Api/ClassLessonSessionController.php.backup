<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\ClassLessonSession;
use App\Models\HomeworkSubmission;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ClassLessonSessionController extends Controller
{
    /**
     * Get homework submissions for a session
     */
    public function getHomeworkSubmissions($classId, $sessionId)
    {
        try {
            Log::info('[HomeworkSubmissions] ðŸ” API called', [
                'class_id' => $classId,
                'session_id' => $sessionId,
                'user_id' => auth()->id(),
            ]);

            $user = auth()->user();
            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Authorization: Check if user has access to this class
            if (!$user->hasRole('super-admin') && !$user->hasRole('admin')) {
                // Check if user is teacher of this class
                $isTeacher = $class->homeroom_teacher_id === $user->id
                    || $class->schedules()->where('teacher_id', $user->id)->exists();

                // Check if user is student in this class
                $isStudent = \App\Models\Student::where('user_id', $user->id)
                    ->whereHas('classes', function($q) use ($class) {
                        $q->where('classes.id', $class->id);
                    })
                    ->exists();

                // Check if user is parent of student in this class
                $isParent = \App\Models\ParentModel::where('user_id', $user->id)
                    ->whereHas('students.classes', function($q) use ($class) {
                        $q->where('classes.id', $class->id);
                    })
                    ->exists();

                if (!$isTeacher && !$isStudent && !$isParent) {
                    Log::warning('[HomeworkSubmissions] âš ï¸ Unauthorized access attempt', [
                        'user_id' => $user->id,
                        'class_id' => $classId,
                        'session_id' => $sessionId,
                    ]);
                    return response()->json([
                        'success' => false,
                        'message' => 'You do not have permission to view homework submissions for this class.'
                    ], 403);
                }
            }

            // Get all submissions for this session
            $submissions = HomeworkSubmission::where('session_id', $sessionId)
                ->with('student')
                ->get();

            Log::info('[HomeworkSubmissions] ðŸ“Š Found submissions', [
                'count' => $submissions->count(),
                'submissions' => $submissions->map(function($sub) {
                    return [
                        'id' => $sub->id,
                        'student_id' => $sub->student_id,
                        'status' => $sub->status,
                        'has_submission_link' => !empty($sub->submission_link),
                        'has_unit_folder_link' => !empty($sub->unit_folder_link),
                    ];
                }),
            ]);

            return response()->json([
                'success' => true,
                'data' => $submissions
            ]);

        } catch (\Exception $e) {
            Log::error('[ClassLessonSession] Error loading homework submissions', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error loading homework submissions'
            ], 500);
        }
    }

    /**
     * Get attendance records for a session
     */
    public function getAttendance($classId, $sessionId)
    {
        try {
            Log::info('[Attendance] Getting attendance for session', [
                'class_id' => $classId,
                'session_id' => $sessionId,
            ]);

            $user = auth()->user();
            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Authorization: Only teachers can access
            if (!$user->hasRole('super-admin') && !$user->hasRole('admin')) {
                $isTeacher = $class->homeroom_teacher_id === $user->id
                    || $class->schedules()->where('teacher_id', $user->id)->exists();

                if (!$isTeacher) {
                    return response()->json([
                        'success' => false,
                        'message' => 'You do not have permission to view attendance.'
                    ], 403);
                }
            }

            // Get all active students in class
            $students = \App\Models\Student::whereHas('classes', function($q) use ($class) {
                $q->where('classes.id', $class->id)
                  ->where('class_students.status', 'active');
            })->with('user')->get();

            // Get existing attendance records
            $attendances = \App\Models\Attendance::where('session_id', $sessionId)->get()->keyBy('student_id');

            $data = $students->map(function($student) use ($attendances) {
                $attendance = $attendances->get($student->user_id);

                return [
                    'student_id' => $student->id,
                    'user_id' => $student->user_id,
                    'student_name' => $student->user->full_name,
                    'student_code' => $student->student_code,
                    'status' => $attendance ? $attendance->status : null,
                    'check_in_time' => $attendance && $attendance->check_in_time
                        ? \Carbon\Carbon::parse($attendance->check_in_time)->format('H:i:s')
                        : null,
                    'late_minutes' => $attendance ? $attendance->late_minutes : 0,
                    // Evaluation fields (for EvaluationModal)
                    'homework_score' => $attendance ? $attendance->homework_score : null,
                    'participation_score' => $attendance ? $attendance->participation_score : null,
                    'notes' => $attendance ? $attendance->notes : null,
                ];
            });

            return response()->json([
                'success' => true,
                'data' => $data
            ]);

        } catch (\Exception $e) {
            Log::error('[Attendance] Error loading attendance', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error loading attendance'
            ], 500);
        }
    }

    /**
     * Save attendance records
     */
    public function saveAttendance(Request $request, $classId, $sessionId)
    {
        try {
            Log::info('[Attendance] Saving attendance', [
                'class_id' => $classId,
                'session_id' => $sessionId,
                'data' => $request->all(),
            ]);

            $user = auth()->user();
            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Authorization: Only teachers can save
            if (!$user->hasRole('super-admin') && !$user->hasRole('admin')) {
                $isTeacher = $class->homeroom_teacher_id === $user->id
                    || $class->schedules()->where('teacher_id', $user->id)->exists();

                if (!$isTeacher) {
                    return response()->json([
                        'success' => false,
                        'message' => 'You do not have permission to save attendance.'
                    ], 403);
                }
            }

            $attendanceData = $request->input('attendance', []);

            foreach ($attendanceData as $data) {
                \App\Models\Attendance::updateOrCreate(
                    [
                        'session_id' => $sessionId,
                        'student_id' => $data['user_id'], // Note: attendance.student_id is actually user_id
                    ],
                    [
                        'status' => $data['status'],
                        'check_in_time' => $data['check_in_time'] ?? null,
                        'late_minutes' => $data['late_minutes'] ?? 0,
                        'marked_by' => $user->id,
                    ]
                );
            }

            return response()->json([
                'success' => true,
                'message' => 'Attendance saved successfully'
            ]);

        } catch (\Exception $e) {
            Log::error('[Attendance] Error saving attendance', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error saving attendance'
            ], 500);
        }
    }

    /**
     * Save evaluation records (detailed evaluation)
     */
    public function saveEvaluations(Request $request, $classId, $sessionId)
    {
        try {
            Log::info('[Evaluation] Saving evaluations', [
                'class_id' => $classId,
                'session_id' => $sessionId,
            ]);

            $user = auth()->user();
            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Authorization: Only teachers can save
            if (!$user->hasRole('super-admin') && !$user->hasRole('admin')) {
                $isTeacher = $class->homeroom_teacher_id === $user->id
                    || $class->schedules()->where('teacher_id', $user->id)->exists();

                if (!$isTeacher) {
                    return response()->json([
                        'success' => false,
                        'message' => 'You do not have permission to save evaluations.'
                    ], 403);
                }
            }

            $evaluations = $request->input('evaluations', []);

            foreach ($evaluations as $data) {
                \App\Models\Attendance::updateOrCreate(
                    [
                        'session_id' => $sessionId,
                        'student_id' => $data['user_id'],
                    ],
                    [
                        'homework_score' => $data['homework_achieved_points'] ?? null,
                        'participation_score' => $data['interaction_score'] ?? null,
                        'notes' => $data['notes'] ?? '',
                        'marked_by' => $user->id,
                    ]
                );
            }

            return response()->json([
                'success' => true,
                'message' => 'Evaluations saved successfully'
            ]);

        } catch (\Exception $e) {
            Log::error('[Evaluation] Error saving evaluations', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error saving evaluations'
            ], 500);
        }
    }

    /**
     * Get student statistics (attendance percentage, homework completion rate)
     */
    public function getStudentStats($classId)
    {
        try {
            Log::info('[StudentStats] Getting stats for class', [
                'class_id' => $classId,
            ]);

            $class = \App\Models\ClassModel::findOrFail($classId);

            // Get all students in class
            $students = \App\Models\Student::whereHas('classes', function($q) use ($class) {
                $q->where('classes.id', $class->id)
                  ->where('class_students.status', 'active');
            })->get();

            // Get only COMPLETED sessions (scheduled_date <= today) for this class
            $sessionIds = $class->lessonSessions()
                ->where('scheduled_date', '<=', now())
                ->pluck('id');
            $totalSessions = $sessionIds->count();

            $stats = [];

            foreach ($students as $student) {
                // Calculate attendance percentage (only for completed sessions)
                $attendedCount = \App\Models\Attendance::where('student_id', $student->user_id)
                    ->whereIn('session_id', $sessionIds)
                    ->where('status', 'present')
                    ->count();

                $attendancePercentage = $totalSessions > 0
                    ? round(($attendedCount / $totalSessions) * 100, 1)
                    : 0;

                // Calculate homework completion rate (only for completed sessions)
                $homeworkSubmittedCount = HomeworkSubmission::where('student_id', $student->user_id)
                    ->whereIn('session_id', $sessionIds)
                    ->whereIn('status', ['submitted', 'graded'])
                    ->count();

                $homeworkCompletionRate = $totalSessions > 0
                    ? round(($homeworkSubmittedCount / $totalSessions) * 100, 1)
                    : 0;

                $stats[$student->user_id] = [
                    'attendance_percentage' => $attendancePercentage,
                    'homework_completion_rate' => $homeworkCompletionRate,
                ];
            }

            return response()->json([
                'success' => true,
                'data' => $stats
            ]);

        } catch (\Exception $e) {
            Log::error('[StudentStats] Error getting stats', [
                'class_id' => $classId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error getting student statistics'
            ], 500);
        }
    }

    /**
     * Send attendance notification to Zalo group
     */
    public function sendAttendanceNotification($classId, $sessionId)
    {
        try {
            Log::info('[ZaloNotification] Sending attendance notification', [
                'class_id' => $classId,
                'session_id' => $sessionId,
            ]);

            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Get attendance records for this session
            $attendances = \App\Models\Attendance::where('session_id', $sessionId)
                ->with('student')
                ->get();

            if ($attendances->isEmpty()) {
                return response()->json([
                    'success' => false,
                    'message' => 'No attendance records found'
                ], 400);
            }

            // Build Zalo message
            $message = "ðŸ“Š ÄIá»‚M DANH - Buá»•i {$session->session_number}";
            $message .= "\nðŸ“… " . \Carbon\Carbon::parse($session->scheduled_date)->format('d/m/Y');
            $message .= "\n\n";

            foreach ($attendances as $attendance) {
                $studentName = $attendance->student->full_name ?? 'Unknown';

                switch ($attendance->status) {
                    case 'present':
                        $message .= "âœ… {$studentName} - CÃ³ máº·t";
                        if ($attendance->check_in_time) {
                            $message .= " (Ä‘Ãºng giá»)";
                        }
                        break;
                    case 'late':
                        $message .= "â° {$studentName} - Äi muá»™n";
                        if ($attendance->late_minutes) {
                            $message .= " ({$attendance->late_minutes} phÃºt)";
                        }
                        break;
                    case 'absent':
                        $message .= "âŒ {$studentName} - Váº¯ng máº·t";
                        break;
                    case 'excused':
                        $message .= "ðŸ“‹ {$studentName} - CÃ³ phÃ©p";
                        break;
                }
                $message .= "\n";
            }

            // Send to Zalo
            $zaloService = app(\App\Services\ZaloNotificationService::class);
            $result = $zaloService->sendToClassGroup($class->id, $message);

            if ($result['success']) {
                return response()->json([
                    'success' => true,
                    'message' => 'Attendance notification sent successfully'
                ]);
            } else {
                return response()->json([
                    'success' => false,
                    'message' => $result['message'] ?? 'Failed to send Zalo notification'
                ], 500);
            }

        } catch (\Exception $e) {
            Log::error('[ZaloNotification] Error sending attendance notification', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error sending notification'
            ], 500);
        }
    }

    /**
     * Send evaluation summary notification to Zalo group
     */
    public function sendEvaluationNotification($classId, $sessionId)
    {
        try {
            Log::info('[ZaloNotification] Sending evaluation notification', [
                'class_id' => $classId,
                'session_id' => $sessionId,
            ]);

            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Get attendance/evaluation records for this session
            $attendances = \App\Models\Attendance::where('session_id', $sessionId)
                ->with('student')
                ->get();

            if ($attendances->isEmpty()) {
                return response()->json([
                    'success' => false,
                    'message' => 'No evaluation records found'
                ], 400);
            }

            // Get homework submissions
            $submissions = HomeworkSubmission::where('session_id', $sessionId)->get()->keyBy('student_id');

            // Calculate stats for each student (only for completed sessions)
            $sessionIds = $class->lessonSessions()
                ->where('scheduled_date', '<=', now())
                ->pluck('id');
            $totalSessions = $sessionIds->count();

            // Build Zalo message
            $message = "ðŸ“ ÄÃNH GIÃ BUá»”I Há»ŒC - Buá»•i {$session->session_number}";
            $message .= "\nðŸ“… " . \Carbon\Carbon::parse($session->scheduled_date)->format('d/m/Y');
            $message .= "\n\n";

            foreach ($attendances as $attendance) {
                $studentName = $attendance->student->full_name ?? 'Unknown';
                $message .= "ðŸ‘¤ {$studentName}:\n";

                // SECTION 1: Lesson Evaluation
                $message .= "ÄÃNH GIÃ BUá»”I Há»ŒC\n";
                $message .= "--------------------------------\n";

                // Interaction score
                if ($attendance->participation_score !== null) {
                    $message .= "ðŸ’¬ Äiá»ƒm tÆ°Æ¡ng tÃ¡c: {$attendance->participation_score}/10\n";
                }

                // Notes/comments
                if ($attendance->notes) {
                    $message .= "ðŸ’­ Nháº­n xÃ©t: {$attendance->notes}\n";
                }

                $message .= "--------------------------------\n";

                // SECTION 2: Course Progress
                $message .= "TIáº¾N TRÃŒNH KHÃ“A Há»ŒC\n";

                // Attendance percentage
                $attendedCount = \App\Models\Attendance::where('student_id', $attendance->student_id)
                    ->whereIn('session_id', $sessionIds)
                    ->where('status', 'present')
                    ->count();
                $attendancePercentage = $totalSessions > 0
                    ? round(($attendedCount / $totalSessions) * 100, 1)
                    : 0;
                $message .= "ðŸ“Š Tá»· lá»‡ Ä‘iá»ƒm danh: {$attendancePercentage}%\n";

                // Homework completion rate
                $homeworkSubmittedCount = HomeworkSubmission::where('student_id', $attendance->student_id)
                    ->whereIn('session_id', $sessionIds)
                    ->whereIn('status', ['submitted', 'graded'])
                    ->count();
                $homeworkCompletionRate = $totalSessions > 0
                    ? round(($homeworkSubmittedCount / $totalSessions) * 100, 1)
                    : 0;
                $message .= "ðŸ“‹ Tá»· lá»‡ hoÃ n thÃ nh BTVN: {$homeworkCompletionRate}%\n";

                // Homework quality (as percentage)
                $submission = $submissions->get($attendance->student_id);
                if ($submission && $attendance->homework_score !== null) {
                    $lessonMaxPoints = $session->lesson_max_points ?? 100;
                    $homeworkQuality = $lessonMaxPoints > 0
                        ? round(($attendance->homework_score / $lessonMaxPoints) * 100, 1)
                        : 0;
                    $message .= "ðŸ“š Cháº¥t lÆ°á»£ng BTVN: {$homeworkQuality}%\n";
                } else {
                    $message .= "ðŸ“š Cháº¥t lÆ°á»£ng BTVN: ChÆ°a cháº¥m\n";
                }

                $message .= "\n";
            }

            // Send to Zalo
            $zaloService = app(\App\Services\ZaloNotificationService::class);
            $result = $zaloService->sendToClassGroup($class->id, $message);

            if ($result['success']) {
                return response()->json([
                    'success' => true,
                    'message' => 'Evaluation notification sent successfully'
                ]);
            } else {
                return response()->json([
                    'success' => false,
                    'message' => $result['message'] ?? 'Failed to send Zalo notification'
                ], 500);
            }

        } catch (\Exception $e) {
            Log::error('[ZaloNotification] Error sending evaluation notification', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error sending notification'
            ], 500);
        }
    }

    /**
     * Get Quick Attendance - Only check permission, not teacher role
     * For users with attendance.quick_mark permission
     */
    public function getQuickAttendance($sessionId)
    {
        try {
            Log::info('[QuickAttendance] Getting attendance for session', [
                'session_id' => $sessionId,
                'user_id' => auth()->id(),
            ]);

            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Get all active students in class
            $students = \App\Models\Student::whereHas('classes', function($q) use ($class) {
                $q->where('classes.id', $class->id)
                  ->where('class_students.status', 'active');
            })->with('user')->get();

            // Get existing attendance records
            $attendances = \App\Models\Attendance::where('session_id', $sessionId)->get()->keyBy('student_id');

            $data = $students->map(function($student) use ($attendances) {
                $attendance = $attendances->get($student->user_id);

                return [
                    'student_id' => $student->id,
                    'user_id' => $student->user_id,
                    'student_name' => $student->user->full_name,
                    'student_code' => $student->student_code,
                    'status' => $attendance ? $attendance->status : null,
                    'check_in_time' => $attendance && $attendance->check_in_time
                        ? \Carbon\Carbon::parse($attendance->check_in_time)->format('H:i:s')
                        : null,
                    'late_minutes' => $attendance ? $attendance->late_minutes : 0,
                ];
            });

            return response()->json([
                'success' => true,
                'data' => $data
            ]);

        } catch (\Exception $e) {
            Log::error('[QuickAttendance] Error loading attendance', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error loading attendance'
            ], 500);
        }
    }

    /**
     * Save Quick Attendance - Only check permission, not teacher role
     */
    public function saveQuickAttendance(Request $request, $sessionId)
    {
        try {
            Log::info('[QuickAttendance] Saving attendance', [
                'session_id' => $sessionId,
                'user_id' => auth()->id(),
            ]);

            $session = ClassLessonSession::findOrFail($sessionId);
            $attendanceData = $request->input('attendance', []);

            foreach ($attendanceData as $data) {
                if (!isset($data['user_id'])) {
                    continue;
                }

                $attendance = \App\Models\Attendance::updateOrCreate(
                    [
                        'session_id' => $sessionId,
                        'student_id' => $data['user_id']
                    ],
                    [
                        'status' => $data['status'] ?? null,
                        'check_in_time' => $data['check_in_time'] ?? null,
                        'late_minutes' => $data['late_minutes'] ?? 0,
                    ]
                );

                Log::debug('[QuickAttendance] Updated attendance', [
                    'student_id' => $data['user_id'],
                    'status' => $data['status'],
                ]);
            }

            return response()->json([
                'success' => true,
                'message' => 'Attendance saved successfully'
            ]);

        } catch (\Exception $e) {
            Log::error('[QuickAttendance] Error saving attendance', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error saving attendance'
            ], 500);
        }
    }

    /**
     * Get Quick Comments - Only check permission, not teacher role
     */
    public function getQuickComments($sessionId)
    {
        try {
            Log::info('[QuickComments] Getting comments for session', [
                'session_id' => $sessionId,
                'user_id' => auth()->id(),
            ]);

            $session = ClassLessonSession::with('class')->findOrFail($sessionId);
            $class = $session->class;

            // Get all active students in class
            $students = \App\Models\Student::whereHas('classes', function($q) use ($class) {
                $q->where('classes.id', $class->id)
                  ->where('class_students.status', 'active');
            })->with('user')->get();

            // Get existing attendance records (which contain comments)
            $attendances = \App\Models\Attendance::where('session_id', $sessionId)->get()->keyBy('student_id');

            $data = $students->map(function($student) use ($attendances) {
                $attendance = $attendances->get($student->user_id);

                return [
                    'student_id' => $student->id,
                    'user_id' => $student->user_id,
                    'student_name' => $student->user->full_name,
                    'student_code' => $student->student_code,
                    'comment' => $attendance ? $attendance->comment : null,
                    'rating' => $attendance ? $attendance->rating : null,
                    'behavior' => $attendance ? $attendance->behavior : null,
                ];
            });

            return response()->json([
                'success' => true,
                'data' => $data
            ]);

        } catch (\Exception $e) {
            Log::error('[QuickComments] Error loading comments', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error loading comments'
            ], 500);
        }
    }

    /**
     * Save Quick Comments - Only check permission, not teacher role
     */
    public function saveQuickComments(Request $request, $sessionId)
    {
        try {
            Log::info('[QuickComments] Saving comments', [
                'session_id' => $sessionId,
                'user_id' => auth()->id(),
            ]);

            $session = ClassLessonSession::findOrFail($sessionId);
            $commentsData = $request->input('comments', []);

            foreach ($commentsData as $data) {
                if (!isset($data['user_id'])) {
                    continue;
                }

                \App\Models\Attendance::updateOrCreate(
                    [
                        'session_id' => $sessionId,
                        'student_id' => $data['user_id']
                    ],
                    [
                        'comment' => $data['comment'] ?? null,
                        'rating' => $data['rating'] ?? null,
                        'behavior' => $data['behavior'] ?? null,
                    ]
                );
            }

            return response()->json([
                'success' => true,
                'message' => 'Comments saved successfully'
            ]);

        } catch (\Exception $e) {
            Log::error('[QuickComments] Error saving comments', [
                'session_id' => $sessionId,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error saving comments'
            ], 500);
        }
    }
}

