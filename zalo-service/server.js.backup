require('dotenv').config();
const express = require('express');
const http = require('http');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const bodyParser = require('body-parser');

const app = express();
const server = http.createServer(app);
const PORT = process.env.PORT || 3001;

// Middleware
app.use(helmet());
app.use(cors({
  origin: process.env.LARAVEL_URL || 'http://127.0.0.1:8000',
  credentials: true
}));
app.use(morgan('combined'));
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// API Routes
const authRoutes = require('./routes/auth');
const messageRoutes = require('./routes/message');
const userRoutes = require('./routes/user');
const groupRoutes = require('./routes/group');
const friendRoutes = require('./routes/friend');
const realtimeRoutes = require('./routes/realtime');
const socketRoutes = require('./routes/socket');
const sessionSharingRoutes = require('./routes/session-sharing');
const { initializeZalo, stopKeepAlive, getAllHealthStatus } = require('./services/zaloClient');

// Initialize WebSocket server for realtime features
const { initializeRealtimeServer, getTotalConnections, getConnectedUsersCount, emitToRoom } = require('./services/realtimeServer');

app.use('/api/auth', authRoutes);
app.use('/api/message', messageRoutes);
app.use('/api/user', userRoutes);
app.use('/api/group', groupRoutes);
app.use('/api/friend', friendRoutes);
app.use('/api/realtime', realtimeRoutes);
app.use('/api/socket', socketRoutes);
app.use('/api/session', sessionSharingRoutes);

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    service: 'Zalo API Service',
    timestamp: new Date().toISOString(),
    websocket: {
      enabled: true,
      connections: getTotalConnections(),
      users: getConnectedUsersCount()
    }
  });
});

// Connection health monitoring status
app.get('/api/health/connections', (req, res) => {
  try {
    const healthStatus = getAllHealthStatus();

    res.json({
      success: true,
      timestamp: new Date().toISOString(),
      accounts: healthStatus
    });
  } catch (error) {
    console.error('[API] Error getting health status:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to get health status'
    });
  }
});

// API endpoint for Laravel to emit WebSocket events
app.post('/api/emit', (req, res) => {
  const { room, event, data } = req.body;

  if (!room || !event || !data) {
    return res.status(400).json({
      success: false,
      error: 'Missing required fields: room, event, data'
    });
  }

  try {
    // Emit to specific room
    emitToRoom(room, event, data);

    console.log(`[API] Emitted ${event} to room ${room}`);

    res.json({
      success: true,
      message: `Event ${event} emitted to room ${room}`
    });
  } catch (error) {
    console.error('[API] Error emitting event:', error);
    res.status(500).json({
      success: false,
      error: 'Failed to emit event'
    });
  }
});

// Error handling
app.use((err, req, res, next) => {
  console.error('Error:', err);
  res.status(err.status || 500).json({
    success: false,
    message: err.message || 'Internal server error'
  });
});

// 404 handler
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: 'Endpoint not found'
  });
});

// Start server
server.listen(PORT, async () => {
  console.log(`ðŸš€ Zalo Service running on port ${PORT}`);
  console.log(`ðŸ“ Environment: ${process.env.NODE_ENV}`);
  console.log(`ðŸ”— Health check: http://localhost:${PORT}/health`);

  // Initialize WebSocket server for realtime features
  const laravelUrl = process.env.LARAVEL_URL || 'http://127.0.0.1:8000';
  initializeRealtimeServer(server, laravelUrl);
  console.log(`ðŸ”Œ WebSocket server ready for realtime connections`);
  console.log(`   Connect from: ${laravelUrl}`);

  // MULTI-SESSION: Auto-initialize is disabled
  // In multi-session mode, accounts are initialized via API endpoints
  // Each account needs its own accountId, so auto-init from .env is not supported
  console.log('â„¹ï¸  Multi-session mode enabled');
  console.log('   Use POST /api/auth/initialize with accountId to login');

  // if (process.env.ZALO_COOKIE && process.env.ZALO_COOKIE !== '') {
  //   console.log('ðŸ” Auto-initializing with saved credentials...');
  //   try {
  //     await initializeZalo();
  //     console.log('âœ… Auto-initialization successful');
  //   } catch (error) {
  //     console.error('âŒ Auto-initialization failed:', error.message);
  //     console.log('   You may need to login with QR code again');
  //   }
  // }
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('ðŸ›‘ SIGTERM received, shutting down gracefully...');
  stopKeepAlive();
  const { stopWebSocketListener } = require('./services/zaloClient');
  stopWebSocketListener();
  process.exit(0);
});

process.on('SIGINT', () => {
  console.log('ðŸ›‘ SIGINT received, shutting down gracefully...');
  stopKeepAlive();
  const { stopWebSocketListener } = require('./services/zaloClient');
  stopWebSocketListener();
  process.exit(0);
});

module.exports = app;

